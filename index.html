<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&display=swap');

        :root {
            --color-bg: #f4f4f4;
            --color-bg-alt: #e0f7fa;
            --color-text: #222;
            --color-primary: #26a69a;
            --color-card: #fff;
            --color-border: #e0e0e0;
            --color-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            --color-nav: #fff;
            --color-nav-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --color-bg: #181a1b;
            --color-bg-alt: #23272a;
            --color-text: #f4f4f4;
            --color-primary: #26a69a;
            --color-card: #23272a;
            --color-border: #333;
            --color-shadow: 0 4px 16px rgba(0, 0, 0, 0.32);
            --color-nav: #23272a;
            --color-nav-shadow: 0 -2px 8px rgba(0, 0, 0, 0.32);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            font-family: 'BIZ UDP Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            overflow: hidden;
        }

        .screen {
            width: 100vw;
            height: 100vh;
            display: none;
        }

        .screen.active {
            display: block;
        }

        .screen>div {
            width: 90%;
            height: 90%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--color-bg-alt);
            border-radius: 1.5em;
            box-shadow: var(--color-shadow);
            position: fixed;
            top: 3%;
            left: 5%;
        }

        h1,
        h2 {
            margin-bottom: 0.5em;
        }

        .main__menu-list {
            display: grid;
            grid-template-rows: repeat(auto-fit, minmax(120px, 1fr));
            gap: 18px;
            width: 90%;
            margin-top: 20px;
        }

        .main__menu-list__rows {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .main__menu-list__item {
            font-size: 1.1em;
            font-weight: 700;
            padding: 18px 8px;
            text-align: center;
            background: var(--color-card);
            border: 1px solid var(--color-border);
            transition: transform 0.2s, background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .main__menu-list__item:hover {
            background: var(--color-primary);
            color: #fff;
            transform: scale(1.04);
        }

        #todoForm input,
        #todo2Form input {
            border-radius: 0.5em;
            border: 1px solid var(--color-border);
            background: var(--color-card);
            color: var(--color-text);
            outline: none;
            transition: border 0.2s;
        }

        #todoForm input:focus,
        #todo2Form input:focus {
            border: 1.5px solid var(--color-primary);
        }

        button {
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: 0.5em;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #00897b;
        }

        #todoCandidates button,
        #todo2Candidates button {
            background: var(--color-card);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 0.5em;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        #todoCandidates button:hover,
        #todo2Candidates button:hover {
            background: var(--color-primary);
            color: #fff;
        }

        #todoList li,
        #todo2List li {
            background: var(--color-card);
            border-radius: 0.5em;
            border: 1px solid var(--color-border);
            margin-bottom: 0.5em;
            box-shadow: var(--color-shadow);
            padding: 0.7em 1em;
            font-size: 1.1em;
            transition: background 0.2s, color 0.2s;
        }

        #todoList li:hover,
        #todo2List li:hover {
            background: var(--color-primary);
            color: #fff;
        }

        nav {
            background: var(--color-nav);
            box-shadow: var(--color-nav-shadow);
        }

        nav button {
            border-radius: 0;
            border-top: 2px solid transparent;
            font-weight: 700;
        }

        nav button.active {
            border-top: 2px solid var(--color-primary);
            color: var(--color-primary);
        }

        @media (max-width: 700px) {
            .screen>div {
                width: 100vw;
                height: calc(100vh - 50px);
                margin: 0;
                border-radius: 0;
                top: 0;
                left: 0;
                padding: 1em;
            }

            #todoForm,
            #todo2Form {
                width: 100%;
                display: flex;
                gap: 0.5em;
                align-items: center;
                flex-wrap: wrap;
            }

            #todoForm>*,
            #todo2Form>* {
                flex: 1;
                white-space: nowrap;
            }

            .main__menu-list {
                width: 100%;
            }
        }
    </style>
    <title>こんだーてMenu</title>
</head>

<body>
    <div class="screen active" id="todo">
        <div class="todo">
            <h2>買い物リスト</h2>
            <form id="todoForm" style="margin-bottom: 1em; display: flex; gap: 0.5em; align-items: center;">
                <select id="todoType" style="font-size:1em; padding:0.5em;">
                    <option value="vegetable">野菜室</option>
                    <option value="fridge">冷蔵庫</option>
                    <option value="freezer">冷凍庫</option>
                    <option value="diary">日用品</option>
                    <option value="stock">ストック</option>
                    <option value="other">その他</option>
                </select>
                <input type="text" id="todoInput" placeholder="新しい買い物を入力" autocomplete="off"
                    style="font-size:1em; padding:0.5em;" />
                <button type="submit" style="font-size:1em; padding:0.5em 1em;">追加</button>
            </form>
            <div id="todoCandidates" style="margin-bottom: 1em;"></div>
            <div id="todoTypeTabs" style="margin-bottom:1em; display:flex; gap:0.5em;"></div>
            <ul id="todoList" style="list-style:none; padding:0; margin:0; height: 70vh; overflow: auto;"></ul>
        </div>
    </div>

    <div class="screen" id="todo2">
        <div class="todo">
            <h2>ToDo</h2>
            <form id="todo2Form" style="margin-bottom: 1em; display: flex; gap: 0.5em; align-items: center;">
                <input type="text" id="todo2Input" placeholder="新しいToDoを入力" autocomplete="off"
                    style="font-size:1em; padding:0.5em;" />
                <button type="submit" style="font-size:1em; padding:0.5em 1em;">追加</button>
            </form>
            <div id="todo2Candidates" style="margin-bottom: 1em;"></div>
            <div id="todo2TypeTabs" style="margin-bottom:1em; display:flex; gap:0.5em;"></div>
            <ul id="todo2List" style="list-style:none; padding:0; margin:0; height: 70vh; overflow: auto;"></ul>
        </div>
    </div>

    <div class="screen" id="other">
        <div class="other">
            <h2>その他のセクション</h2>
            <div style="margin-bottom:1.5em;">
                <label style="font-size:1.1em; font-weight:700;">テーマ切替: </label>
                <button id="themeLightBtn" style="margin-right:0.5em;">ライト</button>
                <button id="themeDarkBtn">ダーク</button>
            </div>
            <button id="enable-push">通知を許可する</button>
        </div>
    </div>

    <script type="module" src="script/todo.js"></script>
    <script type="module" src="script/todo2.js"></script>
    <script>
        // ページ切り替えUI生成・テーマ切替
        document.addEventListener('DOMContentLoaded', function () {
            // 既存の todo, todo2, otherのIDを持つscreenを切り替える
            const screens = ['todo', 'todo2', 'other'];
            // ナビゲーションバーを作成
            const nav = document.createElement('nav');
            nav.style.position = 'fixed';
            nav.style.bottom = '0';
            nav.style.left = '0';
            nav.style.width = '100vw';
            nav.style.background = 'var(--color-nav)';
            nav.style.display = 'flex';
            nav.style.justifyContent = 'space-around';
            nav.style.boxShadow = 'var(--color-nav-shadow)';
            nav.style.zIndex = '1000';

            const navLabels = {
                todo: '買い物リスト',
                todo2: 'ToDo',
                other: 'その他'
            };
            screens.forEach(id => {
                const btn = document.createElement('button');
                btn.textContent = navLabels[id];
                btn.style.flex = '1';
                btn.style.padding = '1em 0';
                btn.style.fontSize = '1em';
                btn.style.border = 'none';
                btn.style.background = 'none';
                btn.style.cursor = 'pointer';
                btn.style.transition = 'background 0.2s';
                btn.classList.toggle('active', id === 'todo');
                btn.addEventListener('click', () => {
                    screens.forEach(sid => {
                        document.getElementById(sid).classList.remove('active');
                        const navBtns = nav.querySelectorAll('button');
                        navBtns.forEach(b => b.classList.remove('active'));
                    });
                    document.getElementById(id).classList.add('active');
                    btn.classList.add('active');
                });
                nav.appendChild(btn);
            });
            document.body.appendChild(nav);

            // テーマ切替
            const themeLightBtn = document.getElementById('themeLightBtn');
            const themeDarkBtn = document.getElementById('themeDarkBtn');
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('kondate-theme', theme);
            }
            if (themeLightBtn && themeDarkBtn) {
                themeLightBtn.addEventListener('click', () => setTheme('light'));
                themeDarkBtn.addEventListener('click', () => setTheme('dark'));
            }
            // 初期テーマ
            const savedTheme = localStorage.getItem('kondate-theme');
            if (savedTheme) {
                setTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                setTheme('dark');
            }
        });
    </script>
    <script type="module">
        // メインの JS ファイル
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.2.0/firebase-messaging.js";
        import { supabase } from "./script/supabase-client.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHlWPBOsmU8X_R8wGNiVlHKxIhpcuUlqY",
            authDomain: "konda-te-menu.firebaseapp.com",
            projectId: "konda-te-menu",
            storageBucket: "konda-te-menu.firebasestorage.app",
            messagingSenderId: "10506812808",
            appId: "1:10506812808:web:a024bd6df2bd3cc7888e3d",
            measurementId: "G-0PXQT959JD"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        async function requestPermissionAndGetToken() {
            try {
                const permission = await Notification.requestPermission();
                if (permission !== "granted") {
                    console.error("通知権限が拒否されました");
                    return;
                }

                // Service Worker を登録
                const registration = await navigator.serviceWorker.register("/konda-te-menu/firebase-messaging-sw.js");
                console.log("Service Worker registered with scope:", registration.scope);

                // トークン取得 (VAPIDキーと登録情報を渡す)
                const token = await getToken(messaging, {
                    vapidKey: "BCPZ4Bi2yY0LNiWG9K5qGh9GNc2MZzbEvqh2EuHIJrPD2zmjfAkDwZ0aXSJO62ohsxVzyj3kRMXiUB9UYS8e9kk",
                    serviceWorkerRegistration: registration
                });

                if (token) {
                    console.log("Device token:", token);
                    // Supabase に保存
                    const { error } = await supabase
                        .from("push_tokens")
                        .upsert({ token: token }, { onConflict: 'token' });

                    if (error) console.error("Supabase Save Error:", error);
                }
            } catch (err) {
                console.error("Error setting up notifications:", err);
            }
        }

        requestPermissionAndGetToken();

        document.getElementById("enable-push").addEventListener("click", () => {
            requestPermissionAndGetToken();
        });

        // フォアグラウンド通知の待機
        onMessage(messaging, (payload) => {
            console.log("Foreground message received:", payload);
            new Notification(payload.notification.title, { body: payload.notification.body });
        });
    </script>
</body>

</html>